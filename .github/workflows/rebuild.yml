name: rebuild

on:
  repository_dispatch: # Webhookからトリガーするためのイベント
    types: [rebuild]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # リポジトリのコードをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v3

      # Node.js のセットアップ
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 依存関係をインストール
      - name: Install dependencies
        run: npm install

      # ビルド
      - name: Build project
        run: npm run build

      # ビルドされたアーティファクトを ZIP ファイルにまとめる
      - name: Create ZIP file
        run: zip -r release.zip ./dist

      # 前回のリリースを取得
      - name: Get previous release
        id: get_release
        uses: actions/github-script@v6
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            if (releases.length > 0) {
              core.setOutput('previous_release', releases[0].tag_name);
            } else {
              core.setOutput('previous_release', null);
            }

      # 前回のリリースファイルをダウンロード
      - name: Download previous release asset
        if: steps.get_release.outputs.previous_release != null
        run: |
          curl -L -o previous_release.zip $(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ steps.get_release.outputs.previous_release }} | jq -r '.assets[0].browser_download_url')

      # ダウンロードした前回のリリースを解凍
      - name: Unzip previous release
        if: steps.get_release.outputs.previous_release != null
        run: unzip previous_release.zip -d previous_build

      # アーティファクトをアップロードして GitHub リリースを作成
      - name: Get current date and time
        id: get_datetime
        run: echo "RELEASE_DATETIME=$(date '+%Y-%m-%d-%H%M%S')" >> $GITHUB_ENV

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: release-${{ env.RELEASE_DATETIME }}
          name: Release ${{ env.RELEASE_DATETIME }}
          body: |
            ## Changes in this release:
            - Describe your changes here
          artifacts: release.zip

      # 現在のビルドも解凍
      - name: Unzip current build
        run: unzip release.zip -d current_build

      - name: List files in previous build
        run: ls -l previous_build

      - name: List files in current build
        run: ls -l current_build

      # 現在のデプロイと直前のリリースファイルの差分を取得
      - name: Compare with previous release
        run: diff -r previous_release current_build > diff_output.txt || true

      # 差分を表示
      - name: Output the differences
        run: cat diff_output.txt

      - name: Upload diff result as artifact
        uses: actions/upload-artifact@v2
        with:
          name: diff-output
          path: diff_output.txt

      # # 差分をZIP化
      # - name: Zip the diff files
      #   run: zip -r diff_release-${{ env.RELEASE_DATETIME }}.zip ./diff_build

      - name: 📂 Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: web/testup.website/deploy-test/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/src/**
            **/public/**
            **/tsconfig.json/**
            **/.vscode/**
            **/.astro/**
            **/README.md*
            **/package.json*
            **/astro.config.mjs*
            **/package-lock.json*
            fileToExclude.txt
