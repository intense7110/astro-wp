name: rebuild

on:
  repository_dispatch: # Webhookã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    types: [rebuild]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      # OpenVPNã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install OpenVPN
        run: sudo apt-get update && sudo apt-get install -y openvpn

      # VPNè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
      - name: Set up VPN configuration
        run: |
          printf "%s" "${{ secrets.VPN_CONFIG }}" > vpn-config.ovpn
      # VPNã«æ¥ç¶š
      - name: Connect to VPN
        run: |
          sudo openvpn --config vpn-config.ovpn --auth-user-pass <(echo -e "${{ secrets.VPN_USERNAME }}\n${{ secrets.VPN_PASSWORD }}") --daemon
          sleep 10  # VPNæ¥ç¶šãŒç¢ºç«‹ã™ã‚‹ã¾ã§å¾…æ©Ÿ

      - name: ğŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: web/testup.website/deploy-test/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            fileToExclude.txt

      # VPNæ¥ç¶šã‚’åˆ‡æ–­
      - name: Disconnect VPN
        run: sudo killall openvpn
